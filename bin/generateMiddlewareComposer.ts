import { writeFile } from 'node:fs/promises'
import * as path from 'node:path'
import * as prettier from 'prettier'

const target = path.join('src', 'MiddlewareComposer.ts')
const max = 20
const range = (to: number) => new Array(to).fill(null).map((_, i) => i + 1)
const joinLines = (lines: string[]) => lines.join('\n')

const output = /* ts */ `
// This is generated by bin/generateMiddlewareComposer.ts
// ... edits this file might be overidden
import { Middleware } from './Middleware.js'

export interface MiddlewareComposer {
${joinLines(
  range(max).map(
    (_, i) => `
<
  O0,
  ${joinLines(
    range(i + 1).map(
      (i) => `
  O${i},`,
    ),
  )}
>(
  initState: O0,
  ${joinLines(
    range(i + 1).map(
      (i) =>
        `
  middleware${i - 1}: Middleware<O${i - 1}, O${i}>,`,
    ),
  )}
): Promise<O${i + 1}>
`,
  ),
)}
}
`

await writeFile(
  target,
  await prettier.format(output, {
    parser: 'typescript',
    ...(await prettier.resolveConfig(target)),
  }),
)
